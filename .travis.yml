language: python

cache: pip

services:
- postgresql

matrix:
  include:
  - python: '3.5'
    env: 'AIOHTTP_VERSION=aiohttp==3.4.4'
  - python: '3.6'
    env: 'AIOHTTP_VERSION=aiohttp==3.4.4'  # WARNING: if you change this, change it in deploy too
  - python: '3.6'
    env: 'AIOHTTP_VERSION=https://github.com/aio-libs/aiohttp/archive/master.zip'
  - python: '3.7'
    dist: xenial
    sudo: required
    env: 'AIOHTTP_VERSION=aiohttp==3.4.4'
  - python: '3.8-dev'
    dist: xenial
    sudo: required
    env: 'AIOHTTP_VERSION=aiohttp==3.4.4'

  allow_failures:
  - python: '3.8-dev'
  - python: '3.7'  # temporary until we can fix tests for 3.7
  - env: 'AIOHTTP_VERSION=https://github.com/aio-libs/aiohttp/archive/master.zip'

install:
- make install
- pip install -U "${AIOHTTP_VERSION}"
- pip freeze

script:
- make lint
- make test
- ./tests/check_tag.py
#- make docs
- pip freeze
- ls -lha

after_success:
- bash <(curl -s https://codecov.io/bash)

deploy:
  provider: pypi
  user: samuelcolvin
  password:
    secure: "yxK4xE/qcKacIjSPbJzlUc1GG7cvcBn+5mzywUbYKgtiMFL1XGXXXqDC8HvEe0pG79Jr2uYezLkoWCdqkUWzQCPKZGG6lqnOWwP8S6LZbyHnSPw9KrHXia2a6zhcTWGg1CD0N9/8vQq3+nauHYXteDKo6pplbVi0/gLTiTQNJnT7V+nJzNR1jh7wlqkYCwzZ0wPbPSEwCUNZ32LtpDDWIgJ3tzICM2vR2sUQKv3T4B2I9AHYoGVOSFNVH9BeneNzSyyAaskuQG+vN3zCbxLozxa3fyKmY34q9nEgvKbmfk05sk+AdCXNXRAyHENuopxF8UojpjP9j1ty/S3qfEsA3kT6Pv62kSLwsKcBuiUy4Ju1Mu37qwOMIT2XPmQ9Phbt5+V+VtSy3CClNSnuFQA2gUsjMNEe6j32KLJHu0lcQYFfou+5DYKs1oIf615m1x3JGsFLEgcDqTjCR3BAZoJ8N/b+aS6ZcRX7YLl6JbFiQ9Wvs7fSkXp4cntjDqnA0NAQ6fAjX9ByUBaXN2jndwm2qAmPHnZwHi5TJSIPXJUERE/1DRIz+EAFXiM2njUxSP0EOwqNlA4YzH919nfRNTLBPobk7XRa+6cyO5Z4Z24Tec0CqXIB+qBQo756H3bShdAAa1ZTF4CNZ7r9jPPGHQsZlWdd0Qs/uH5GWsLoiM9d0g4="
  distributions: sdist bdist_wheel
  # skip_cleanup: true is required to include livereload.js
  skip_cleanup: true
  on:
    tags: true
    python: 3.6
    condition: "$AIOHTTP_VERSION = aiohttp==3.4.4"
